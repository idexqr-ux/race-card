<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>The Race Card</title>

  <style>
    body {
      font-family: Georgia, "Times New Roman", Times, serif;
      color: #2b2b2b;
      background: #f7f6f3;
      line-height: 1.6;
      padding: 16px;
    }

    h1 {
      font-size: 1.4em;
      margin: 12px 0;
      color: #1f1f1f;
    }

    /* ASK — big, calm, phone-first */
    #askButton {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;

      width: 100%;
      max-width: 560px;
      margin: 0 auto 24px auto;

      min-height: 112px;
      padding: 20px;

      font-family: inherit;
      font-size: 2em;
      line-height: 1.1;

      border-radius: 999px;
      border: none;
      background: #ffffff;
      color: #2b2b2b;

      box-shadow: 0 3px 10px rgba(0,0,0,0.12);
      cursor: pointer;
    }

    .ask-sub {
      font-size: 0.8em;
      margin-top: 6px;
      color: #5a5a5a;
    }

    .panel {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }

    /* Reinforced phrase (visual whisper): recognition only, never dominates */
    .reinforce {
      display: inline-block;
      margin: 0 0 10px 0;

      font-family: inherit;
      font-size: 0.92em;
      letter-spacing: 0.06em;
      text-transform: uppercase;

      color: #6a6a6a;
      opacity: 0.9;

      user-select: none;
    }

    /* Safety reinforcement: allowed to be a touch firmer */
    .reinforce--safety {
      color: #4f4f4f;
      opacity: 1;
    }

    #answerText {
      min-height: 3em;
      opacity: 0.85;
    }

    .back-link {
      display: inline-block;
      margin-top: 14px;

      font-size: 1.05em;
      color: #6a6a6a;

      padding: 12px 8px;
      border-radius: 10px;

      cursor: pointer;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
    }

    .back-link:hover {
      color: #2b2b2b;
    }

    /* raceContext is kept for future multi-race logic, but hidden to keep the Ask page calm and moment-focused */
    #raceContext {
      position: absolute;
      left: -9999px;
      top: auto;
      width: 1px;
      height: 1px;
      overflow: hidden;
    }
  </style>
</head>

<body>

  <div id="raceContext" aria-hidden="true">Race</div>

  <button id="askButton" type="button" aria-pressed="false">
    <div>Ask</div>
    <div class="ask-sub" id="statusLine">about the race card</div>
  </button>

  <h1>The Race Card</h1>

  <div class="panel">
    <!-- visual whisper label (kept out of screen readers) -->
    <div id="reinforceLabel" class="reinforce" aria-hidden="true"></div>
    <p id="answerText" role="status" aria-live="polite">&nbsp;</p>
  </div>

  <div class="back-link" onclick="goBackSmart()">
    ← Back to race
  </div>

  <script>
    // --- URL params (quiet config; no UI change) ---
    const params = new URLSearchParams(window.location.search);

    // Race context (future multi-race ready)
    const raceContext = document.getElementById('raceContext');
    const race = params.get('race');
    if (raceContext) {
      raceContext.textContent = race ? `Race ${race}` : "Race";
    }

    // --- Quiet context from QR (never shown to user) ---
    const venue = (params.get('venue') || 'ptp').toLowerCase();   // ptp | course | show
    const scale = (params.get('scale') || '').toLowerCase();      // small | medium | large (optional)
    const area = (params.get('area') || '').toLowerCase();        // shetland | natives | main (optional)
    const landmark = params.get('landmark') || 'the busiest part of the course';

    function goBackSmart() {
      if (window.history.length > 1) {
        window.history.back();
        return;
      }
      window.location.href = "./";
    }

    function bumpAsked(id) {
      const key = `asked_${id}`;
      const n = Number(sessionStorage.getItem(key) || "0") + 1;
      sessionStorage.setItem(key, String(n));
      return n;
    }

    function mapAllowed(moment) {
      if (scale !== 'medium' && scale !== 'large') return false;
      return (moment === 'ring_disambiguation' || moment === 'after_the_bell' || moment === 'leaving');
    }

    function inferMomentFromText(q = "") {
      const t = String(q).toLowerCase();

      if (t.includes("get out") || t.includes("exit") || t.includes("car park") || t.includes("satnav")) return "leaving";
      if (t.includes("am i needed") || t.includes("should i stay") || t.includes("miss")) return "holding_pattern";
      if (t.includes("now what") || t.includes("silverware") || t.includes("parade")) return "after_the_bell";
      if (t.includes("a or b") || t.includes("which side") || t.includes("this side") || t.includes("mini") || t.includes("standard")) return "ring_disambiguation";
      if (t.includes("where is ring") || t.includes("where is the ring")) return "class_finding";

      return "settling_in";
    }

    (function () {
      const btn = document.getElementById('askButton');
      const status = document.getElementById('statusLine');
      const panel = document.getElementById('answerText');

      // NEW: reinforcement hook
      const reinforce = document.getElementById('reinforceLabel');

      function setReinforce(text, safety = false) {
        if (!text) {
          reinforce.textContent = "";
          reinforce.classList.remove('reinforce--safety');
          return;
        }
        reinforce.textContent = text;
        reinforce.classList.toggle('reinforce--safety', safety);
      }

      const ANSWERS = {
        loo: {
          kind: "protected",
          tags: ["orientation", "body", "high"],
          text: ({ venue, landmark }) => {
            if (venue === "ptp") {
              return `You’re not the only one to ask — it’s good to know early. At point-to-points the loos are usually portable and set up in a few different spots. If you head towards the ${landmark} or the busiest part of the course, you’ll usually find one nearby, with signs once you’re close.`;
            }
            return `You’re not the only one to ask — it’s good to know early. The nearest loos are usually just off the main concourse, close to the parade ring. There are signs once you’re close, and it’s worth noting there’s often another set a little further round if the nearest ones are busy later on.`;
          }
        },

        carpark_entrance: {
          kind: "protected",
          tags: ["orientation", "exit", "high"],
          text: () =>
            `It’s a common question at the end of the day — you’re not the only one. The car park entrance is usually reached by following the main exit routes from the course. If you head towards where most people are leaving, the signs should guide you once you’re close.`
        },

        food: {
          kind: "protected",
          tags: ["comfort", "social", "medium"],
          text: ({ venue, landmark }) => {
            if (venue === "ptp") {
              return `Food and coffee are usually around the ${landmark} or the main gathering areas. They’re often busiest just before and between races — which is also when you tend to bump into familiar faces.`;
            }
            return `Food and coffee are usually around the main concourse and gathering areas. They’re often busiest just before and between races — which is also when you tend to bump into familiar faces.`;
          }
        },

        first_race_time: {
          kind: "protected",
          tags: ["timing", "arrival", "medium"],
          text: () =>
            `The first race is usually at [time]. You’ve got a bit of breathing space before it starts — enough time to get your bearings and enjoy the build-up.`
        },

        num_races: {
          kind: "protected",
          tags: ["timing", "planning", "medium"],
          text: () =>
            `There are usually [number] races on the card today. It’s a helpful one to know on arrival, especially if you’re planning to leave before the final queues build up.`
        },

        mind_your_backs: {
          kind: "cultural",
          tags: ["ptp_only", "cultural"],
          text: ({ venue }) => {
            if (venue !== "ptp") return "";
            return `You may hear “mind your backs, please” — it’s a polite way of saying there’s a horse coming through behind you, so on hearing it, it’s best to step aside.`;
          }
        }
      };

      function softenIfRepeated(answerId, text, meta) {
        const askedCount = bumpAsked(answerId);
        const isOrientation = meta?.tags?.includes("orientation");

        if (!isOrientation || askedCount <= 1) return text;

        if (answerId === "loo") {
          if (venue === "ptp") {
            return `Loos are usually near the ${landmark} or the main gathering areas. Head towards the busiest part of the course — the signs will guide you once you’re close.`;
          }
          return `Loos are usually just off the main concourse near the parade ring. Head that way — the signs will guide you once you’re close.`;
        }

        if (answerId === "carpark_entrance") {
          return `Car park entrance is usually reached via the main exit routes. Head towards where most people are leaving — signs should guide you once you’re close.`;
        }

        return text;
      }

      const intents = [
        {
          id: "form",
          label: "Form comment",
          example: "What does ‘ev ch til drvn & one pce 3 out’ mean?",
          answer:
            "This is shorthand describing how the horse travelled during the race. Expanded into plain English, it means the horse was always prominent, was being pushed along before the finish, and could only maintain one pace from three fences out."
        },
        {
          id: "term",
          label: "Racing term",
          example: "What does OR mean?",
          answer:
            "OR stands for Official Rating. It’s a numerical assessment of a horse’s ability, used to help level the field in handicaps."
        },
        {
          id: "going",
          label: "Going / ground",
          example: "Why does the going matter?",
          answer:
            "The going describes how firm or soft the ground is. Some horses perform best on soft ground, others on firmer ground, so it can significantly affect how a race unfolds."
        },
        {
          id: "colours",
          label: "Colours",
          example: "What do the colours tell me?",
          answer:
            "The colours identify the owner and help you visually follow a horse during the race. They don’t affect performance, but they make tracking the right runner much easier."
        },
        {
          id: "race-type",
          label: "Race type",
          example: "What’s a novice race?",
          answer:
            "A novice race is restricted to horses that have not won before a certain date or over a certain discipline, allowing less experienced horses to compete against similar rivals."
        },
        {
          id: "how-to-read",
          label: "How to read the card",
          example: "What should I look at first?",
          answer:
            "Most people start with the race time, how many runners there are and what type of race. You don’t need to read everything — just enough to orient yourself before the race begins."
        }
      ];

      const CONTEXT = { venue, scale, area, landmark, race };

      const SEQUENCE = [
        { type: "intent", id: "how-to-read" },
        { type: "protected", id: "first_race_time" },
        { type: "protected", id: "loo" },
        { type: "intent", id: "term" },
        { type: "intent", id: "going" },
        { type: "protected", id: "food" },
        { type: "intent", id: "form" },
        { type: "intent", id: "colours" },
        { type: "intent", id: "race-type" },
        { type: "protected", id: "num_races" },
        { type: "protected", id: "carpark_entrance" },
        { type: "cultural", id: "mind_your_backs" }
      ];

      let seqIndex = 0;
      let state = "idle";

      function showAnswerFromSequence() {
        const item = SEQUENCE[seqIndex % SEQUENCE.length];
        seqIndex++;

        if (item.type === "intent") {
          setReinforce(null);
          const intent = intents.find(x => x.id === item.id) || intents[0];
          panel.textContent = intent.answer;
          return;
        }

        const meta = ANSWERS[item.id];
        if (!meta) {
          setReinforce(null);
          panel.textContent = "Tell me the exact phrase you’re looking at and I’ll expand it into plain race-day English — without guessing.";
          return;
        }

        let text = meta.text(CONTEXT);
        if (!text) return showAnswerFromSequence();

        text = softenIfRepeated(item.id, text, meta);

        // Visual reinforcement (quiet anchors only)
        if (item.id === "loo") setReinforce("LOOS");
        else if (item.id === "carpark_entrance") setReinforce("EXIT");
        else if (item.id === "mind_your_backs") setReinforce("MIND YOUR BACKS", true);
        else setReinforce(null);

        panel.textContent = text;
      }

      function setState(next) {
        state = next;

        if (state === "idle") {
          status.textContent = "about the race card";
          panel.innerHTML = "&nbsp;";
          setReinforce(null);
          btn.setAttribute("aria-pressed", "false");
          return;
        }

        if (state === "listening") {
          status.textContent = "Listening…";
          panel.textContent = "Say your question as you would to the person beside you.";
          setReinforce(null);
          btn.setAttribute("aria-pressed", "true");
          return;
        }

        status.textContent = "Answer";
        showAnswerFromSequence();
        btn.setAttribute("aria-pressed", "false");
      }

      btn.addEventListener('click', () => {
        if (state === "idle") return setState("listening");
        if (state === "listening") return setState("answering");
        return setState("listening");
      });

      setState("idle");
    })();
  </script>

</body>
</html>
